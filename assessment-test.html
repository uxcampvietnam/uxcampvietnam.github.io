<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Form Câu Hỏi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .question {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .answers {
            margin-left: 20px;
        }

        img {
            max-width: 200px;
            display: block;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>Bài Trắc Nghiệm</h1>
    <form id="quizForm">
        <div id="questions"></div>
        <button type="submit">Nộp Bài</button>
    </form>

    <script>
        const STORAGE_KEY = "quiz_answers";

        // --- CSV PARSER đơn giản ---
        function parseCSV(text) {
            const rows = [];
            let current = '';
            let row = [];
            let insideQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"' && insideQuotes && nextChar === '"') {
                    // gặp "" trong chuỗi => thêm 1 dấu " vào giá trị
                    current += '"';
                    i++;
                } else if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    row.push(current);
                    current = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    if (current !== '' || row.length > 0) {
                        row.push(current);
                        rows.push(row);
                        row = [];
                        current = '';
                    }
                    // bỏ qua \r\n (Windows newline)
                    if (char === '\r' && nextChar === '\n') i++;
                } else {
                    current += char;
                }
            }
            // dòng cuối
            if (current !== '' || row.length > 0) {
                row.push(current);
                rows.push(row);
            }

            const headers = rows[0].map(h => h.trim());
            return rows.slice(1).map(r => {
                const obj = {};
                headers.forEach((h, i) => obj[h] = (r[i] || '').trim());
                return obj;
            });
        }

        // --- LocalStorage ---
        function loadTempAnswers() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        }
        function saveTempAnswers(answers) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(answers));
        }

        // --- Render ---
        function renderQuestions(data) {
            console.log(data);
            const container = document.getElementById("questions");
            const savedAnswers = loadTempAnswers();

            data.forEach(q => {
                if (!q.question_id) return;

                const qDiv = document.createElement("div");
                qDiv.className = "question";

                let html = `<p><b>${q.question_id}. ${q.question}</b></p>`;
                if (q.img_code) {
                    html += `<img src="${q.img_code}.png" alt="image">`;
                }

                html += `<div class="answers">`;

                ["a", "b", "c", "d"].forEach(opt => {
                    const ansText = q["answer_" + opt];
                    if (ansText && ansText.trim() !== "") {
                        const inputType = q.type === "single_choice" ? "radio" : "checkbox";
                        const nameAttr = q.type === "single_choice" ? q.question_id : q.question_id + "[]";
                        const checked = savedAnswers[q.question_id]?.includes(opt) ? "checked" : "";
                        html += `
              <label>
                <input type="${inputType}" 
                       name="${q.question_id}" 
                       value="${opt}" ${checked}> 
                ${ansText}
              </label><br>`;
                    }
                });

                html += `</div>`;
                qDiv.innerHTML = html;
                container.appendChild(qDiv);
            });

            // Event lưu tạm khi chọn
            document.querySelectorAll("input[type=radio], input[type=checkbox]").forEach(input => {
                input.addEventListener("change", () => {
                    const answers = loadTempAnswers();
                    const qid = input.name.replace("[]", "");
                    if (input.type === "radio") {
                        answers[qid] = [input.value];
                    } else {
                        const checkboxes = document.querySelectorAll(`input[name='${input.name}']`);
                        answers[qid] = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
                    }
                    saveTempAnswers(answers);
                });
            });
        }

        // --- Load CSV ---
        fetch("question_bank_uxcamp_in.csv")
            .then(res => res.text())
            .then(text => {
                const data = parseCSV(text);
                renderQuestions(data);
            });

        // --- Submit ---
        document.getElementById("quizForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const answers = loadTempAnswers();
            console.log("Đáp án nộp:", answers);

            // TODO: gửi answers lên server nếu cần
            // fetch("/submit", { method:"POST", body: JSON.stringify(answers) })

            localStorage.removeItem(STORAGE_KEY);
            alert("Đã nộp bài thành công!");
        });
    </script>
</body>

</html>