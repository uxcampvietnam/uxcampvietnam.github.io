<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Collection - Tab & Task</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            background-color: var(--main-colors-background-B200, #FCF0E0);
        }

        .container {
            width: 100%;
            max-width: 800px;
            flex-direction: column;
            align-items: center;
            padding: 24px;
        }

        .collection-header {
            width: 100%;
            margin-bottom: 24px;
            text-align: left;
        }

        .collection-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--main-colors-foreground-F500);
            margin-bottom: 8px;
        }

        .collection-meta {
            font-size: 14px;
            color: var(--main-colors-foreground-F600);
        }

        .savedTabList {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            list-style: none;
            padding: 0;
        }

        .error-message {
            color: #d32f2f;
            padding: 20px;
            background: #ffebee;
            border-radius: 8px;
        }

        /* Override styles for standalone page */
        .savedTabItem {
            cursor: pointer;
        }

        .delete-btn {
            display: none !important;
            /* No delete in public view */
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="loading">Loading collection...</div>
        <div id="content" class="hidden" style="width: 100%;">
            <div class="collection-header">
                <div class="collection-title" id="folderTitle"></div>
                <div class="collection-meta" id="folderMeta"></div>
            </div>
            <ul class="savedTabList" id="tabList"></ul>
        </div>
        <div id="error" class="hidden error-message"></div>
    </div>

    <!-- Configuration Script (Inject your Supabase Config here or load from common file if possible) -->
    <!-- For this demo, we assume we need to hardcode or read from a shared config file. 
         Since verify_uuid.js is not shown to contain config, I will use a placeholder or try to read from newtab-src if it had it.
         Wait, user said "Tab & Task Supabase", assuming the config is known or I should use the same one.
         For the standalone page to work 'via a webpage', it likely needs the config embedded or fetched.
         I'll add a script that attempts to reuse the existing config strategy if applicable, 
         or I will ask the user to provide the URL/Key if I can't find it.
         However, for now I will use the pattern seen in newtab-src.js: window.SUPABASE_CONFIG.
         I will include a config.js if it exists, otherwise I'll need to extract it.
    -->

    <script>
        window.SUPABASE_CONFIG = {
            url: "https://yzqtzrbkxkvtachwpdxt.supabase.co",   // e.g. https://xxxxxxxx.supabase.co
            anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6cXR6cmJreGt2dGFjaHdwZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzEzODIsImV4cCI6MjA4NTg0NzM4Mn0.i4a1rYYCmxnqrFAEdPEh7Blon95Lcj0qgbdoeniFZLk",   // Project API key (anon public)
            // Where to send users after they click the email confirmation or password reset link (must be in Supabase Redirect URLs)
            emailRedirectTo: "https://uxcamp.vn/"
        };
        // Fallback config if config.js is missing or doesn't set it (You should replace these with your project details)
        if (!window.SUPABASE_CONFIG) {
            console.warn("SUPABASE_CONFIG not found. Please ensure config.js is present or keys are set.");
            // Try to load from local storage or prompt? No, public page needs it.
            // For now, I'll rely on the user having a config.js or similar.
            // If the user hasn't created a config.js, I should probably create one or extract keys from where they are initialized.
        }

        async function loadPublicCollection() {
            const params = new URLSearchParams(window.location.search);
            const folderId = params.get('id');

            if (!folderId) {
                showError("No collection ID specified.");
                return;
            }

            if (!window.SUPABASE_CONFIG) {
                showError("Configuration missing. Please checking console.");
                return;
            }

            const supabase = window.supabase.createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);

            try {
                // 1. Fetch Folder
                const { data: folder, error: folderError } = await supabase
                    .from('folders')
                    .select('*')
                    .eq('id', folderId)
                    .single();

                if (folderError) throw folderError;
                if (!folder) throw new Error("Collection not found.");
                if (!folder.is_public) {
                    // Check if we are logged in? 
                    // For public view, if is_public is false, we try to see if user has access via share?
                    // But this page is "Public Access Page". If it's private and user is not logged in, it fails.
                    // If user IS logged in, they might see it.
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) {
                        throw new Error("This collection is private.");
                    }
                    // If logged in, RLS will handle visibility.
                }

                // 2. Fetch Tabs
                const { data: tabs, error: tabsError } = await supabase
                    .from('tabs')
                    .select('*')
                    .eq('folder_id', folderId)
                    .order('position');

                if (tabsError) throw tabsError;

                renderCollection(folder, tabs);

            } catch (err) {
                console.error(err);
                showError(err.message || "Failed to load collection.");
            }
        }

        function renderCollection(folder, tabs) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            document.getElementById('folderTitle').textContent = folder.title || "Untitled Collection";
            document.getElementById('folderMeta').textContent = `${tabs.length} items`; // â€¢ Created ${new Date(folder.created_at).toLocaleDateString()}

            const list = document.getElementById('tabList');
            list.innerHTML = '';

            if (tabs.length === 0) {
                list.innerHTML = '<li style="color: #666;">No tabs in this collection.</li>';
                return;
            }

            tabs.forEach(tab => {
                const li = document.createElement('li');
                li.className = 'savedTabItem';
                li.onclick = () => window.open(tab.url, '_blank');

                li.innerHTML = `
                    <img class="favicon" src="${tab.favIconUrl || 'assets/uxcamp-logo.svg'}" alt="icon" onerror="this.src='assets/uxcamp-logo.svg'">
                    <span>${tab.title}</span>
                `;
                list.appendChild(li);
            });
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            const errDiv = document.getElementById('error');
            errDiv.textContent = msg;
            errDiv.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', loadPublicCollection);
    </script>
</body>

</html>