<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Collection - Tab & Task</title>
    <link rel="stylesheet" href="../style/style.css">
    <link rel="stylesheet" href="../style/definition.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        .hidden {
            display: none;
        }

        .favicon {
            width: 24px;
            height: 24px;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 24px;
            margin-bottom: 120px;
        }

        .collection-header {
            width: 100%;
            margin-bottom: 12px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-direction: row;
        }

        .savedTabList {
            display: flex;
            align-items: center;
            align-content: center;
            gap: 8px;
            align-self: stretch;
            padding-inline-start: 0px !important;
            margin: 0px;
            padding-top: 12px;
            overflow: hidden;
            flex-direction: column;
        }

        .savedTabItem span {
            @supports (-webkit-line-clamp: 2) {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: initial;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }
        }

        .error-message {
            background-color: var(--alternative-foreground-red);
            padding: 20px;
            color: var(--main-colors-background-b100);
            border-radius: 8px;
        }

        /* Override styles for standalone page */
        .savedTabItem {
            display: flex;
            height: 72px;
            box-sizing: border-box;
            width: 100%;
            padding: 12px;
            align-items: center;
            gap: 8px;
            /* flex: 1 0 0; */
            border: 1px solid var(--transparent-foreground-main-color-10);
            background-color: var(--saved-tab-item-background);
            overflow: hidden;
            border-radius: 4px;
            cursor: pointer;
        }

        .savedTabItem:hover {
            background-color: var(--saved-tab-item-background-hover);
        }

        .share-tag {
            background-color: var(--transparent-foreground-main-color-10);
            color: var(--main-colors-foreground-f300);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="container">
        <p id="loading">Loading collection...</p>
        <div id="content" class="hidden" style="width: 100%;">
            <div class="collection-header">
                <span class="collection-title h1" id="folderTitle"></span>
                <div class="share-tag caption">public</div>
                <p class="collection-meta caption" id="folderMeta"></p>
            </div>
            <ul class="savedTabList" id="tabList"></ul>
        </div>
        <p id="error" class="hidden error-message "></p>
    </div>


    <script>
        if (!window.SUPABASE_CONFIG) {
            console.warn("SUPABASE_CONFIG not found. Please ensure config.js is present or keys are set.");
        }

        async function loadPublicCollection() {
            const params = new URLSearchParams(window.location.search);
            const folderId = params.get('id');

            if (!folderId) {
                showError("No collection ID specified.");
                return;
            }

            if (!window.SUPABASE_CONFIG) {
                showError("Configuration missing. Please checking console.");
                return;
            }

            const supabase = window.supabase.createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);

            try {
                // 1. Fetch Folder
                // Use maybeSingle() so that when RLS returns 0 rows (private/non-existent folder)
                // we get null instead of a hard PGRST116 error.
                const { data: folder, error: folderError } = await supabase
                    .from('folders')
                    .select('*')
                    .eq('id', folderId)
                    .eq('is_deleted', false)
                    .maybeSingle();

                if (folderError) throw folderError;
                if (!folder) throw new Error("Collection not found or is not publicly accessible.");
                if (!folder.is_public) {
                    // Check if we are logged in? 
                    // For public view, if is_public is false, we try to see if user has access via share?
                    // But this page is "Public Access Page". If it's private and user is not logged in, it fails.
                    // If user IS logged in, they might see it.
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) {
                        throw new Error("This collection is private.");
                    }
                    // If logged in, RLS will handle visibility.
                }

                // 2. Fetch Tabs
                const { data: tabs, error: tabsError } = await supabase
                    .from('tabs')
                    .select('*')
                    .eq('folder_id', folderId)
                    .eq('is_deleted', false)
                    .order('position');

                if (tabsError) throw tabsError;

                renderCollection(folder, tabs);

            } catch (err) {
                console.error(err);
                showError(err.message || "Failed to load collection.");
            }
        }

        function renderCollection(folder, tabs) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            document.getElementById('folderTitle').textContent = folder.name || "Untitled Collection";
            document.title = "Shared folder: " + (folder.name || "Untitled Collection");
            document.getElementById('folderMeta').textContent = `${tabs.length} items`; // â€¢ Created ${new Date(folder.created_at).toLocaleDateString()}

            const list = document.getElementById('tabList');
            list.innerHTML = '';

            if (tabs.length === 0) {
                list.innerHTML = '<li style="color: #666;">No tabs in this collection.</li>';
                return;
            }

            tabs.forEach(tab => {
                const li = document.createElement('li');
                li.className = 'savedTabItem';
                li.onclick = () => window.open(tab.url, '_blank');

                li.innerHTML = `
                    <img class="favicon" src="${tab.favicon || '../asset/image/Eye.svg'}" alt="icon" onerror="this.src='../asset/image/Eye.svg'">
                    <span class="">${tab.title}</span>
                `;
                list.appendChild(li);
            });
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            const errDiv = document.getElementById('error');
            errDiv.textContent = msg;
            errDiv.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', loadPublicCollection);
    </script>
</body>

</html>